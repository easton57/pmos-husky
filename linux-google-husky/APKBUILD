# Rteference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/(CHANGEME!)

pkgname=linux-google-husky
pkgver=6.1.124
pkgrel=0
pkgdesc="Google Pixel 8 Pro kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="google-husky"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	android-tools
	python3
	bash
	bc
	bison
	devicepkg-dev
	findutils
	flex
	openssl-dev
	perl
	linux-headers
	gcc
	elfutils-dev
	lz4
	mkbootimg
"

# Source
_repository="linux-pixel"
_commit="0088b07046f3429f998dd4a30cba4224c0e9a09d" # AOSP
# _commit="7f0705f383d094e10bbfddf75a0487b8e6ad632f" # Mainline efforts
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/easton57/$_repository/archive/$_commit.tar.gz
	$_config
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$arch" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	mkdir -p "$pkgdir"/boot

	make Image.lz4 modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_PATH="$pkgdir"/boot \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs
	rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

	install -D "$builddir"/include/config/kernel.release \
		"$pkgdir"/usr/share/kernel/$_flavor/kernel.release

	install -Dm644 "$builddir/arch/$_carch/boot/Image.lz4" \
		"$pkgdir/boot/vmlinuz"

	# Build a vendor_boot image
	# mkbootimg \
	# --vendor_boot \
	# --header_version 4 \
	# --pagesize 2048 \
	# --kernel "$builddir/arch/$_carch/boot/Image.gz" \
	# --ramdisk some_shiz \
	# --dtb "$pkgdir/boot/dtbs/zuma-husky-mp-zuma-b0-foplp.dtb" \
	# --kernel_addr 0x10008000 \
	# --ramdisk_addr 0x11000000 \
	# --dtb_addr 0x11f00000 \
	# -o pmos_husky_vendor_kernel_boot.img
}

sha512sums="
52ba0d6167596814bfdcd6d4e417ff8c65fdcb13139f36afcbca7b9403036d896974794a85a0ab66a94c71bc4b532e72257ffb1c3026bd8955071bffdd3c8422  linux-google-husky-0088b07046f3429f998dd4a30cba4224c0e9a09d.tar.gz
7e91c09f8c4767c987b4d78afc689f9d4695f217b16f82a931d1650b7e9e820fb3651e7c11a0b22f8cf4aaf98168e1419dc1098cfe80243b6a3369b9aace0728  config-google-husky.aarch64
"

# Rteference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/(CHANGEME!)

pkgname=linux-google-husky
# pkgver=6.1.124
pkgver=6.17.0
pkgrel=0
pkgdesc="Google Pixel 8 Pro kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="google-husky"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	android-tools
	python3
	bash
	bc
	bison
	devicepkg-dev
	findutils
	flex
	openssl-dev
	perl
	linux-headers
	gcc
	elfutils-dev
	lz4
	mkbootimg
"

# Source
_repository="linux-pixel"
# _commit="0088b07046f3429f998dd4a30cba4224c0e9a09d" # AOSP
_commit="87803c16abbf5de72b28c756fa29f86fec492d29" # Mainline efforts
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/easton57/$_repository/archive/$_commit.tar.gz
	$_config
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$arch" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	mkdir -p "$pkgdir"/boot

	make Image.lz4 modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_PATH="$pkgdir"/boot \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs
	rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

	install -D "$builddir"/include/config/kernel.release \
		"$pkgdir"/usr/share/kernel/$_flavor/kernel.release

	install -Dm644 "$builddir/arch/$_carch/boot/Image.lz4" \
		"$pkgdir/boot/vmlinuz"

	# Build a vendor_boot image
	# mkbootimg \
	# --vendor_boot \
	# --header_version 4 \
	# --pagesize 2048 \
	# --kernel "$builddir/arch/$_carch/boot/Image.gz" \
	# --ramdisk some_shiz \
	# --dtb "$pkgdir/boot/dtbs/zuma-husky-mp-zuma-b0-foplp.dtb" \
	# --kernel_addr 0x10008000 \
	# --ramdisk_addr 0x11000000 \
	# --dtb_addr 0x11f00000 \
	# -o pmos_husky_vendor_kernel_boot.img
}

sha512sums="
b2a2fc7184b4e6d0f828f5460d450e17926ee5f176fec61544bc7ab440399cc9919f5d33887a8e485df4b58b7be595c3b9c6fc03b405c0f5f5390e48604ece5a  linux-google-husky-87803c16abbf5de72b28c756fa29f86fec492d29.tar.gz
5dd86e2df3f0d1e7cf18d88e41877fc2a45c41d616daa9f53160f36d5f350aff539119e90f011e341080fbe63da45f1f4b15dafb01d878cd38d93a4993295a8f  config-google-husky.aarch64
"
